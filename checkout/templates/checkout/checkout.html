{% extends 'base.html' %}
{% load static %}
{% load dishes_extras %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'checkout/css/checkout.css' %}" />
{% endblock %}

{% block content %}
  <div class="container my-4">
    <h2 class="text-center mb-4">Checkout</h2>

    {% if bag_items %}
      <div class="row">
        <!-- BAG SUMMARY -->
        <div class="col-md-6">
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white">
              <h5 class="mb-0">Your Order</h5>
            </div>
            <div class="card-body">
              <ul class="list-group">
                {% for item in bag_items %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <strong>{{ item.portion.dish.name }}</strong><br />
                      Portion: {{ item.portion.size }}<br />
                      Quantity: {{ item.quantity }}
                    </div>
                    <span>₦{{ item.line_total }}</span>
                  </li>
                {% endfor %}
              </ul>

              <hr />
              <h4 class="text-end">Total: ₦{{ grand_total }}</h4>

              <div class="text-center mt-3">
                <a href="{% url 'dish_list' %}" class="btn btn-outline-secondary">Modify Bag</a>
              </div>
            </div>
          </div>
        </div>

        <!-- CHECKOUT FORM -->
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Enter Your Details</h5>
            </div>
            <div class="card-body">
              <form method="post" id="payment-form">
                {% csrf_token %}
                {{ form.non_field_errors }}

                {% for field in form %}
                  <div class="mb-3">
                    <label class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                      <small class="text-muted">{{ field.help_text }}</small>
                    {% endif %}
                    <div class="text-danger">{{ field.errors }}</div>
                  </div>
                {% endfor %}

                <!-- STRIPE CARD ELEMENT -->
                <div class="mb-3">
                  <label class="form-label">Card details</label>
                  <div id="card-element" class="form-control"></div>
                  <div id="card-errors" class="text-danger mt-2"></div>
                </div>

                <!-- SAVE INFO CHECKBOX -->
                <div class="form-check mb-3">
                  <input type="checkbox" id="id-save-info" class="form-check-input" />
                  <label for="id-save-info" class="form-check-label">Save payment info</label>
                </div>

                <!-- LOADING OVERLAY -->
                <div id="loading-overlay" class="d-none text-center">
                  <div class="spinner-border mt-3"></div>
                </div>

                <button id="submit-button" class="btn btn-success w-100 mt-3">Pay Now</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="alert alert-warning text-center">
        Your bag is empty.
        <br /><br />
        <a href="{% url 'dish_list' %}" class="btn btn-primary">Browse Dishes</a>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block postloadjs %}
  {{ block.super }}
  {{ stripe_public_key|json_script:'id_stripe_public_key' }}
  {{ client_secret|json_script:'id_client_secret' }}
  <script src="{% static 'checkout/js/checkout.js' %}"></script>
{% endblock %}
