{% extends 'base.html' %}
{% load static %}
{% load dishes_extras %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dishes/css/dishes.css' %}">
{% endblock %}

{% block content %}
<div class="container py-5">

  <!-- TITLE -->
  <h2 class="fw-bold text-center mb-4 text-white">
    <i class="fa-solid fa-plate-wheat"></i> Our Dishes
  </h2>

  <!-- SEARCH -->
  <form method="get"
        action="{% url 'dish_list' %}"
        id="search-form"
        class="d-flex justify-content-center mb-4 gap-2 flex-wrap">

    {% if current_category %}
      <input type="hidden" name="category" value="{{ current_category.slug }}">
    {% endif %}

    <input type="text"
           id="search-input"
           name="q"
           value="{{ search_term }}"
           placeholder="Search dishes..."
           class="form-control w-50">

    <button class="btn btn-warning fw-bold shop-now-button">
      <i class="fas fa-search"></i>
    </button>
  </form>

  <!-- CATEGORY FILTER -->
  <div class="category-filter mb-4 text-center">
    {% with base=request.GET|remove_keys:'category,page' %}
      <a href="{% url 'dish_list' %}"
         class="badge all {% if not current_category %}active{% endif %}">
         All
      </a>

      {% for category in categories %}
        <a href="?{{ base }}{% if base %}&{% endif %}category={{ category.slug }}"
           class="badge category {% if current_category and current_category.slug == category.slug %}active{% endif %}">
           {{ category.name }}
        </a>
      {% endfor %}
    {% endwith %}
  </div>

  <!-- ADVANCED FILTERS -->
  <div class="d-flex justify-content-center gap-2 mb-4 flex-wrap">
    {% with base=request.GET|remove_keys:'page' %}

    <!-- PRICE -->
    <div class="dropdown">
      <button class="btn btn-warning btn-sm dropdown-toggle shop-now-button" data-bs-toggle="dropdown">
        Price
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="?{{ base }}&max_price=10">Under $10</a></li>
        <li><a class="dropdown-item" href="?{{ base }}&min_price=10&max_price=20">$10 â€“ $20</a></li>
        <li><a class="dropdown-item" href="?{{ base }}&min_price=20">Over $20</a></li>
      </ul>
    </div>

    <!-- DIETARY -->
    <div class="dropdown">
      <button class="btn btn-warning btn-sm dropdown-toggle shop-now-button" data-bs-toggle="dropdown">
        Dietary
      </button>
      <ul class="dropdown-menu">
        {% for option in dietary_choices %}
          <li>
            <a class="dropdown-item" href="?{{ base }}&dietary={{ option }}">
              {{ option }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- INGREDIENT -->
    <div class="dropdown">
      <button class="btn btn-warning btn-sm dropdown-toggle shop-now-button" data-bs-toggle="dropdown">
        Ingredients
      </button>
      <ul class="dropdown-menu">
        {% for ing in ingredient_choices %}
          <li>
            <a class="dropdown-item" href="?{{ base }}&ingredient={{ ing }}">
              {{ ing|capfirst }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- RESET -->
    <a href="{% url 'dish_list' %}" class="btn btn-secondary btn-sm">
      Reset Filters
    </a>

    {% endwith %}
  </div>

  <!-- DISH GRID -->
  <div class="row g-4">
    {% for dish in dishes %}
      <div class="col-lg-3 col-md-4 col-sm-6">
        <div class="card h-100 shadow-sm border-0 dish-card">

          {% if dish.image %}
            <img src="{{ dish.image.url }}" class="card-img-top rounded-top-4">
          {% else %}
            <img src="{% static 'images/no-image.png' %}" class="card-img-top rounded-top-4">
          {% endif %}

          <div class="card-body text-center">
            <h6 class="fw-bold">{{ dish.name }}</h6>
            <p class="text-muted small">{{ dish.description|truncatewords:12 }}</p>

            {% if dish.portions.exists %}
              <select class="form-select mb-2 portion-select">
                {% for portion in dish.portions.all %}
                  <option value="{{ portion.id }}"
                          data-price="{{ portion.price }}"
                          {% if forloop.first %}selected{% endif %}>
                    {{ portion.size }} - ${{ portion.price }}
                  </option>
                {% endfor %}
              </select>
              <p class="fw-bold text-warning dish-price">
                ${{ dish.portions.first.price }}
              </p>
            {% else %}
              <p class="fw-bold text-warning dish-price">${{ dish.price }}</p>
            {% endif %}

            <div class="d-flex justify-content-center gap-2 mb-2">
              <button type="button" class="btn btn-outline-secondary dish-qty-decrement">-</button>
              <input type="number" class="form-control dish-qty" value="1" min="1" style="width:70px;">
              <button type="button" class="btn btn-outline-secondary dish-qty-increment">+</button>
            </div>

            <button class="btn btn-warning fw-bold w-100 add-bag-button"
                    data-id="{{ dish.id }}">
              Add to Bag
            </button>

            <a href="{{ dish.get_absolute_url }}" class="btn btn-secondary btn-sm w-100 mt-2">
              View Details
            </a>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-center text-muted">No dishes found.</p>
    {% endfor %}
  </div>

  <!-- PAGINATION -->
  {% if dishes.has_other_pages %}
    <nav class="mt-4">
      <ul class="pagination justify-content-center">
        {% for num in dishes.paginator.page_range %}
          {% with base=request.GET|remove_keys:'page' %}
            <li class="page-item {% if dishes.number == num %}active{% endif %}">
              <a class="page-link" href="?{{ base }}{% if base %}&{% endif %}page={{ num }}">
                {{ num }}
              </a>
            </li>
          {% endwith %}
        {% endfor %}
      </ul>
    </nav>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'dishes/js/bag.js' %}"></script>
<script src="{% static 'dishes/js/search.js' %}"></script>
{% endblock %}
